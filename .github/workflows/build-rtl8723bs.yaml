name: Build kmod-rtl8723bs x86_64 (024c:b723)

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
            python3-distutils rsync unzip zlib1g-dev file wget time

      - name: Clone OpenWrt
        run: |
          git clone https://git.openwrt.org/openwrt/openwrt.git
          cd openwrt

      - name: Update and install feeds
        working-directory: openwrt
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure for x86_64 and enable kmod-rtl8723bs
        working-directory: openwrt
        run: |
          cat > .config << 'EOF'
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y
CONFIG_PACKAGE_kmod-rtl8723bs=m
EOF
          make defconfig

      - name: Download source packages
        working-directory: openwrt
        run: |
          make download -j$(nproc) V=s

      - name: Patch rtl8723bs driver to add SDIO ID 024c:b723
        working-directory: openwrt
        run: |
          # Tunggu sampai kernel source di-extract
          make target/linux/compile -j1 V=s IGNORE_ERRORS='n m' || true
          
          # Cari file sdio_intf.c
          SDIO_FILE=$(find build_dir -path "*/drivers/staging/rtl8723bs/os_dep/sdio_intf.c" 2>/dev/null | head -n1)
          
          if [ -z "$SDIO_FILE" ]; then
            echo "Error: sdio_intf.c not found"
            exit 1
          fi
          
          echo "Found sdio_intf.c at: $SDIO_FILE"
          
          # Backup original
          cp "$SDIO_FILE" "$SDIO_FILE.bak"
          
          # Tambahkan ID 024c:b723 menggunakan sed
          sed -i '/{ SDIO_DEVICE(0x024c, 0x0626) },/a\    { SDIO_DEVICE(0x024c, 0xb723) },' "$SDIO_FILE"
          
          # Verifikasi patch berhasil
          if grep -q "0xb723" "$SDIO_FILE"; then
            echo "Patch successful: ID 024c:b723 added"
            grep -A2 -B2 "0xb723" "$SDIO_FILE"
          else
            echo "Patch failed"
            exit 1
          fi

      - name: Build kmod-rtl8723bs
        working-directory: openwrt
        run: |
          make package/kernel/mac80211/compile -j$(nproc) V=s

      - name: Collect artifacts
        working-directory: openwrt
        run: |
          mkdir -p ../artifacts
          find bin/targets -name "*rtl8723bs*" -type f -exec cp {} ../artifacts/ \;
          find bin/packages -name "*rtl8723bs*" -type f -exec cp {} ../artifacts/ \;
          ls -lh ../artifacts/

      - name: Upload kmod-rtl8723bs package
        uses: actions/upload-artifact@v4
        with:
          name: kmod-rtl8723bs-x86_64-patched
          path: artifacts/*
          if-no-files-found: error
