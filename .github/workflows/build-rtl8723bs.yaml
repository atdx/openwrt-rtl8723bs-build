name: Build kmod-rtl8723bs x86_64 (024c:b723)

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y git build-essential libncurses5-dev zlib1g-dev \
            gawk flex gettext wget unzip python3 rsync time

      - name: Clone OpenWrt
        run: |
          git clone https://git.openwrt.org/openwrt/openwrt.git
          cd openwrt

      - name: Config x86_64 & feeds
        working-directory: openwrt
        run: |
          make defconfig
          sed -i 's/^CONFIG_TARGET_.*=.*/# CONFIG_TARGET_.* is not set/' .config || true
          cat << 'EOF' >> .config
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y
EOF
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          yes "" | make defconfig

      - name: Enable kmod-rtl8723bs
        working-directory: openwrt
        run: |
          ./scripts/diffconfig.sh > seed.config || true
          echo "CONFIG_PACKAGE_kmod-rtl8723bs=m" >> seed.config
          mv seed.config .config
          yes "" | make defconfig

      - name: Download sources
        working-directory: openwrt
        run: |
          make download -j"$(nproc)"

      - name: Patch rtl8723bs SDIO ID
        working-directory: openwrt
        run: |
          KDIR=$(find build_dir -maxdepth 6 -type d -name "linux-*" | head -n1 || true)
          if [ -z "$KDIR" ]; then
            echo "Kernel dir not found"; exit 1
          fi
          echo "Kernel dir: $KDIR"
          cd "$KDIR"/..

          FILE=$(find . -path "*drivers/staging/rtl8723bs/os_dep/sdio_intf.c" | head -n1 || true)
          if [ -z "$FILE" ]; then
            echo "sdio_intf.c not found"; exit 1
          fi
          echo "Patching: $FILE"

          python3 - << 'EOF'
from pathlib import Path

path = Path(r"""$FILE""")
text = path.read_text()

needle = """    { SDIO_DEVICE(0x024c, 0x0626) },"""
insert = """    { SDIO_DEVICE(0x024c, 0x0626) },
    { SDIO_DEVICE(0x024c, 0xb723) },"""

if insert in text:
    print("ID 0xb723 already present, nothing to do")
else:
    if needle not in text:
        raise SystemExit("Pattern not found in sdio_intf.c")
    text = text.replace(needle, insert)
    path.write_text(text)
    print("Patched 024c:b723 into", path)
EOF

      - name: Build kmod-rtl8723bs
        working-directory: openwrt
        run: |
          make package/kernel/mac80211/compile V=s -j"$(nproc)"

      - name: Collect artifacts
        working-directory: openwrt
        run: |
          mkdir -p ../artifacts
          find bin -iname "*rtl8723bs*" -type f -print -exec cp {} ../artifacts/ \;

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kmod-rtl8723bs-x86_64-024c-b723
          path: artifacts/
